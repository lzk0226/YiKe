<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ruoyi.yike.mapper.NoteMapper">

    <!-- åŸºç¡€ç»“æžœæ˜ å°„ -->
    <resultMap id="NoteResultMap" type="com.ruoyi.yike.domain.Note">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="description" column="description"/>
        <result property="subjectId" column="subject_id"/>
        <result property="noteTypeId" column="note_type_id"/>
        <result property="userId" column="user_id"/>
        <result property="views" column="views"/>
        <result property="likes" column="likes"/>
        <result property="favorites" column="favorites"/>
        <result property="rating" column="rating"/>
        <result property="ratingCount" column="rating_count"/>

        <!-- å…³è” Subject -->
        <association property="subject" javaType="com.ruoyi.yike.domain.Subject">
            <id property="id" column="subject_id"/>
            <result property="name" column="subject_name"/>
            <result property="code" column="subject_code"/>
        </association>

        <!-- å…³è” NoteType -->
        <association property="noteType" javaType="com.ruoyi.yike.domain.NoteType">
            <id property="id" column="note_type_id"/>
            <result property="name" column="note_type_name"/>
            <result property="code" column="note_type_code"/>
        </association>

        <!-- å…³è” User -->
        <association property="author" javaType="com.ruoyi.yike.domain.User">
            <id property="id" column="user_id"/>
            <result property="nickname" column="author_nickname"/>
        </association>
    </resultMap>

    <!-- å¡ç‰‡ç»“æžœæ˜ å°„ï¼ˆä¸åŒ…å«contentå­—æ®µï¼Œå‡å°‘æ•°æ®ä¼ è¾“ï¼‰ -->
    <resultMap id="NoteCardResultMap" type="com.ruoyi.yike.domain.Note">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="description" column="description"/>
        <result property="subjectId" column="subject_id"/>
        <result property="noteTypeId" column="note_type_id"/>
        <result property="userId" column="user_id"/>
        <result property="views" column="views"/>
        <result property="likes" column="likes"/>
        <result property="favorites" column="favorites"/>
        <result property="rating" column="rating"/>
        <result property="ratingCount" column="rating_count"/>

        <!-- å…³è” Subject -->
        <association property="subject" javaType="com.ruoyi.yike.domain.Subject">
            <id property="id" column="subject_id"/>
            <result property="name" column="subject_name"/>
            <result property="code" column="subject_code"/>
        </association>

        <!-- å…³è” NoteType -->
        <association property="noteType" javaType="com.ruoyi.yike.domain.NoteType">
            <id property="id" column="note_type_id"/>
            <result property="name" column="note_type_name"/>
            <result property="code" column="note_type_code"/>
        </association>

        <!-- å…³è” User -->
        <association property="author" javaType="com.ruoyi.yike.domain.User">
            <id property="id" column="user_id"/>
            <result property="nickname" column="author_nickname"/>
        </association>
    </resultMap>

    <!-- è¯¦æƒ…ç»“æžœæ˜ å°„ï¼ˆåŒ…å«æ‰€æœ‰å­—æ®µå’Œé¢å¤–ä¿¡æ¯ï¼‰ -->
    <resultMap id="NoteDetailResultMap" type="com.ruoyi.yike.domain.Note">
        <id property="id" column="id"/>
        <result property="title" column="title"/>
        <result property="content" column="content"/>
        <result property="description" column="description"/>
        <result property="subjectId" column="subject_id"/>
        <result property="noteTypeId" column="note_type_id"/>
        <result property="userId" column="user_id"/>
        <result property="views" column="views"/>
        <result property="likes" column="likes"/>
        <result property="favorites" column="favorites"/>
        <result property="rating" column="rating"/>
        <result property="ratingCount" column="rating_count"/>

        <!-- å…³è” Subject -->
        <association property="subject" javaType="com.ruoyi.yike.domain.Subject">
            <id property="id" column="subject_id"/>
            <result property="name" column="subject_name"/>
            <result property="code" column="subject_code"/>
        </association>

        <!-- å…³è” NoteType -->
        <association property="noteType" javaType="com.ruoyi.yike.domain.NoteType">
            <id property="id" column="note_type_id"/>
            <result property="name" column="note_type_name"/>
            <result property="code" column="note_type_code"/>
        </association>

        <!-- å…³è” User -->
        <association property="author" javaType="com.ruoyi.yike.domain.User">
            <id property="id" column="user_id"/>
            <result property="nickname" column="author_nickname"/>
            <result property="avatar" column="author_avatar"/>
            <result property="email" column="author_email"/>
        </association>

        <!-- å…³è”å›¾ç‰‡åˆ—è¡¨ -->
        <collection property="images" ofType="com.ruoyi.yike.domain.NoteImage">
            <id property="id" column="img_id"/>
            <result property="noteId" column="id"/>
            <result property="imageUrl" column="img_url"/>
            <!-- æ³¨æ„ï¼šæ•°æ®åº“ image_order æ˜ å°„åˆ°å®žä½“ç±» imageOrder -->
            <result property="imageOrder" column="img_order"/>
        </collection>
    </resultMap>

    <!-- å…¬å…±WHEREæ¡ä»¶ç‰‡æ®µ -->
    <sql id="noteFilterConditions">
        WHERE n.status = 1
        <if test="subjectId != null">
            AND n.subject_id = #{subjectId}
        </if>
        <if test="noteTypeId != null">
            AND n.note_type_id = #{noteTypeId}
        </if>
    </sql>

    <!-- åŽŸæœ‰æŸ¥è¯¢ï¼šæŸ¥è¯¢æ‰€æœ‰ç¬”è®° -->
    <select id="selectAllNotes" resultMap="NoteResultMap">
        SELECT n.id, n.title, n.content, n.description,
               n.subject_id, n.note_type_id, n.user_id,
               n.views, n.likes, n.favorites, n.rating, n.rating_count,
               s.name AS subject_name, s.code AS subject_code,
               t.name AS note_type_name, t.code AS note_type_code,
               u.nickname AS author_nickname
        FROM notes n
                 LEFT JOIN subjects s ON n.subject_id = s.id
                 LEFT JOIN note_types t ON n.note_type_id = t.id
                 LEFT JOIN users u ON n.user_id = u.id
        WHERE n.status = 1
        ORDER BY n.created_at DESC
    </select>

    <!-- åŽŸæœ‰æŸ¥è¯¢ï¼šæ ¹æ®IDæŸ¥è¯¢ç¬”è®° -->
    <select id="selectNoteById" resultMap="NoteResultMap">
        SELECT n.id, n.title, n.content, n.description,
               n.subject_id, n.note_type_id, n.user_id,
               n.views, n.likes, n.favorites, n.rating, n.rating_count,
               s.name AS subject_name, s.code AS subject_code,
               t.name AS note_type_name, t.code AS note_type_code,
               u.nickname AS author_nickname
        FROM notes n
                 LEFT JOIN subjects s ON n.subject_id = s.id
                 LEFT JOIN note_types t ON n.note_type_id = t.id
                 LEFT JOIN users u ON n.user_id = u.id
        WHERE n.id = #{id} AND n.status = 1
    </select>

    <!-- æœ€æ–°å‘å¸ƒ -->
    <select id="selectNoteCardsLatest" resultMap="NoteCardResultMap">
        SELECT n.id, n.title, n.description,
        n.subject_id, n.note_type_id, n.user_id,
        n.views, n.likes, n.favorites, n.rating, n.rating_count,
        s.name AS subject_name, s.code AS subject_code,
        t.name AS note_type_name, t.code AS note_type_code,
        u.nickname AS author_nickname
        FROM notes n
        LEFT JOIN subjects s ON n.subject_id = s.id
        LEFT JOIN note_types t ON n.note_type_id = t.id
        LEFT JOIN users u ON n.user_id = u.id
        <include refid="noteFilterConditions"/>
        ORDER BY n.created_at DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- æœ€å¤šé˜…è¯» -->
    <select id="selectNoteCardsMostRead" resultMap="NoteCardResultMap">
        SELECT n.id, n.title, n.description,
        n.subject_id, n.note_type_id, n.user_id,
        n.views, n.likes, n.favorites, n.rating, n.rating_count,
        s.name AS subject_name, s.code AS subject_code,
        t.name AS note_type_name, t.code AS note_type_code,
        u.nickname AS author_nickname
        FROM notes n
        LEFT JOIN subjects s ON n.subject_id = s.id
        LEFT JOIN note_types t ON n.note_type_id = t.id
        LEFT JOIN users u ON n.user_id = u.id
        <include refid="noteFilterConditions"/>
        ORDER BY n.views DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- è¯„åˆ†æœ€é«˜ -->
    <select id="selectNoteCardsTopRated" resultMap="NoteCardResultMap">
        SELECT n.id, n.title, n.description,
        n.subject_id, n.note_type_id, n.user_id,
        n.views, n.likes, n.favorites, n.rating, n.rating_count,
        s.name AS subject_name, s.code AS subject_code,
        t.name AS note_type_name, t.code AS note_type_code,
        u.nickname AS author_nickname
        FROM notes n
        LEFT JOIN subjects s ON n.subject_id = s.id
        LEFT JOIN note_types t ON n.note_type_id = t.id
        LEFT JOIN users u ON n.user_id = u.id
        <include refid="noteFilterConditions"/>
        ORDER BY n.rating DESC, n.rating_count DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- æœ€å¤šæ”¶è— -->
    <select id="selectNoteCardsMostFavorited" resultMap="NoteCardResultMap">
        SELECT n.id, n.title, n.description,
        n.subject_id, n.note_type_id, n.user_id,
        n.views, n.likes, n.favorites, n.rating, n.rating_count,
        s.name AS subject_name, s.code AS subject_code,
        t.name AS note_type_name, t.code AS note_type_code,
        u.nickname AS author_nickname
        FROM notes n
        LEFT JOIN subjects s ON n.subject_id = s.id
        LEFT JOIN note_types t ON n.note_type_id = t.id
        LEFT JOIN users u ON n.user_id = u.id
        <include refid="noteFilterConditions"/>
        ORDER BY n.favorites DESC
        LIMIT #{offset}, #{pageSize}
    </select>

    <!-- æŸ¥è¯¢ç¬”è®°è¯¦æƒ… -->
    <select id="selectNoteDetailById" resultMap="NoteDetailResultMap">
        SELECT n.id, n.title, n.content, n.description,
        n.subject_id, n.note_type_id, n.user_id,
        n.views, n.likes, n.favorites, n.rating, n.rating_count,
        s.name AS subject_name, s.code AS subject_code,
        t.name AS note_type_name, t.code AS note_type_code,
        u.nickname AS author_nickname, u.avatar AS author_avatar, u.email AS author_email,
        ni.id AS img_id, ni.image_url AS img_url,
        ni.image_order AS img_order  <!-- ðŸ‘ˆ ç»™ image_order èµ·åˆ«å img_order -->
        FROM notes n
        LEFT JOIN subjects s ON n.subject_id = s.id
        LEFT JOIN note_types t ON n.note_type_id = t.id
        LEFT JOIN users u ON n.user_id = u.id
        LEFT JOIN note_images ni ON n.id = ni.note_id
        WHERE n.id = #{id} AND n.status = 1
        ORDER BY ni.image_order ASC
    </select>
    <!-- ä¿®å¤ï¼šæ ¹æ®ç­›é€‰æ¡ä»¶æŸ¥è¯¢ç¬”è®°æ€»æ•° -->
    <select id="selectNoteTotal" resultType="int">
        SELECT COUNT(*)
        FROM notes n
        <include refid="noteFilterConditions"/>
    </select>

</mapper>