<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>登录 / 注册</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Open Sans', 'Microsoft YaHei', Helvetica, Arial, sans-serif;
      background: #ededed;
    }

    input,
    button {
      border: none;
      outline: none;
      background: none;
      font-family: 'Open Sans', 'Microsoft YaHei', Helvetica, Arial, sans-serif;
    }

    .tip {
      font-size: 20px;
      margin: 40px auto 50px;
      text-align: center;
      font-weight: bold;
      /* 加粗 */
      font-style: italic;
      /* 倾斜 */
      background: linear-gradient(90deg, #ff7e5f, #feb47b);
      /* 渐变色 */
      -webkit-background-clip: text;
      /* 背景裁剪为文字形状 */
      -webkit-text-fill-color: transparent;
      /* 让文字透明以显示渐变背景 */
    }



    .cont {
      overflow: hidden;
      position: relative;
      width: 900px;
      height: 550px;
      margin: 0 auto 100px;
      background: #fff;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }

    .form {
      position: relative;
      width: 640px;
      height: 100%;
      transition: transform 1.2s ease-in-out;
      padding: 50px 30px 0;
    }

    .sub-cont {
      overflow: hidden;
      position: absolute;
      left: 640px;
      top: 0;
      width: 900px;
      height: 100%;
      padding-left: 260px;
      background: #fff;
      transition: transform 1.2s ease-in-out;
    }

    .cont.s--signup .sub-cont {
      transform: translate3d(-640px, 0, 0);
    }

    button {
      display: block;
      margin: 0 auto;
      width: 260px;
      height: 36px;
      border-radius: 30px;
      color: #fff;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .img {
      overflow: hidden;
      z-index: 2;
      position: absolute;
      left: 0;
      top: 0;
      width: 260px;
      height: 100%;
      padding-top: 360px;
    }

    .img:before {
      content: '';
      position: absolute;
      right: 0;
      top: 0;
      width: 900px;
      height: 100%;
      background-image: url('https://images.unsplash.com/photo-1557683316-973673baf926?w=1200');
      background-size: cover;
      background-position: center;
      transition: transform 1.2s ease-in-out;
    }

    .cont.s--signup .img:before {
      transform: translate3d(640px, 0, 0);
    }

    .img:after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
    }

    .img__text {
      z-index: 2;
      position: absolute;
      left: 0;
      top: 50px;
      width: 100%;
      padding: 0 20px;
      text-align: center;
      color: #fff;
      transition: transform 1.2s ease-in-out;
    }

    .img__text h2 {
      margin-bottom: 10px;
      font-weight: normal;
      font-size: 24px;
    }

    .img__text p {
      font-size: 14px;
      line-height: 1.5;
    }

    .img__text.m--up {
      transform: translateX(0);
    }

    .cont.s--signup .img__text.m--up {
      transform: translateX(520px);
    }

    .img__text.m--in {
      transform: translateX(-520px);
    }

    .cont.s--signup .img__text.m--in {
      transform: translateX(0);
    }

    .img__btn {
      overflow: hidden;
      z-index: 2;
      position: relative;
      width: 100px;
      height: 36px;
      margin: 0 auto;
      background: transparent;
      color: #fff;
      text-transform: uppercase;
      font-size: 15px;
      cursor: pointer;
    }

    .img__btn:after {
      content: '';
      z-index: 2;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      border: 2px solid #fff;
      border-radius: 30px;
      transition: all 0.3s;
    }

    .img__btn:hover:after {
      background: rgba(255, 255, 255, 0.1);
    }

    .img__btn span {
      position: absolute;
      left: 0;
      top: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      width: 100%;
      height: 100%;
      transition: transform 1.2s;
    }

    .img__btn span.m--in {
      transform: translateY(-72px);
    }

    .cont.s--signup .img__btn span.m--in {
      transform: translateY(0);
    }

    .cont.s--signup .img__btn span.m--up {
      transform: translateY(72px);
    }

    h2 {
      width: 100%;
      font-size: 26px;
      text-align: center;
      margin-bottom: 10px;
    }

    label {
      display: block;
      width: 260px;
      margin: 25px auto 0;
      text-align: center;
    }

    label span {
      font-size: 12px;
      color: #cfcfcf;
      text-transform: uppercase;
    }

    input {
      display: block;
      width: 100%;
      margin-top: 5px;
      padding-bottom: 5px;
      font-size: 16px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.4);
      text-align: center;
      transition: border-color 0.3s;
    }

    input:focus {
      border-bottom-color: #d4af7a;
    }

    input.error {
      border-bottom-color: #f44336;
    }

    .forgot-pass {
      margin-top: 15px;
      text-align: center;
      font-size: 12px;
      color: #cfcfcf;
      cursor: pointer;
      transition: color 0.3s;
    }

    .forgot-pass:hover {
      color: #d4af7a;
    }

    .submit {
      margin-top: 40px;
      margin-bottom: 20px;
      background: #d4af7a;
      text-transform: uppercase;
    }

    .submit:hover {
      background: #c49a63;
    }

    .sign-in {
      transition-timing-function: ease-out;
    }

    .cont.s--signup .sign-in {
      transition-timing-function: ease-in-out;
      transition-duration: 1.2s;
      transform: translate3d(640px, 0, 0);
    }

    .sign-up {
      transform: translate3d(-900px, 0, 0);
    }

    .cont.s--signup .sign-up {
      transform: translate3d(0, 0, 0);
    }

    /* 消息提示样式 */
    .message {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 4px;
      color: white;
      font-size: 14px;
      z-index: 10000;
      opacity: 0;
      transition: opacity 0.3s ease;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .message-success {
      background: #4CAF50;
    }

    .message-error {
      background: #f44336;
    }

    .message-info {
      background: #2196F3;
    }

    /* 响应式设计 */
    @media (max-width: 900px) {
      .cont {
        width: 100%;
        margin: 20px;
      }
    }
  </style>
</head>

<body>

  <p class="tip">欢迎使用忆课</p>

  <div class="cont">
    <div class="form sign-in">
      <h2>欢迎回来</h2>
      <label>
        <span>邮箱 *</span>
        <input type="email" id="login-email" placeholder="请输入邮箱" required />
      </label>
      <label>
        <span>密码 *</span>
        <input type="password" id="login-password" placeholder="请输入密码" required />
      </label>
      <p class="forgot-pass">忘记密码？</p>
      <button type="button" class="submit" id="login-btn">登录</button>
    </div>

    <div class="sub-cont">
      <div class="img">
        <div class="img__text m--up">
          <h2>还没有账号？</h2>
          <p>立即注册，探索更多精彩内容！</p>
        </div>
        <div class="img__text m--in">
          <h2>已经注册？</h2>
          <p>如果您已有账号，请直接登录。我们很想念您！</p>
        </div>
        <div class="img__btn">
          <span class="m--up">注册</span>
          <span class="m--in">登录</span>
        </div>
      </div>

      <div class="form sign-up">
        <h2>加入我们</h2>
        <label>
          <span>用户名（可选）</span>
          <input type="text" id="reg-username" placeholder="留空则使用邮箱前缀" />
        </label>
        <label>
          <span>邮箱 *</span>
          <input type="email" id="reg-email" placeholder="请输入邮箱" required />
        </label>
        <label>
          <span>密码 *</span>
          <input type="password" id="reg-password" placeholder="至少6位字符" required minlength="6" />
        </label>
        <label>
          <span>确认密码 *</span>
          <input type="password" id="confirm-password" placeholder="再次输入密码" required />
        </label>
        <button type="button" class="submit" id="register-btn">注册</button>
      </div>
    </div>
  </div>

  <script>
    // API配置
    const API_BASE_URL = 'http://localhost:8080/user';

    // DOM元素
    const cont = document.querySelector('.cont');
    const imgBtn = document.querySelector('.img__btn');

    // 登录表单元素
    const loginEmail = document.getElementById('login-email');
    const loginPassword = document.getElementById('login-password');
    const loginBtn = document.getElementById('login-btn');

    // 注册表单元素
    const regUsername = document.getElementById('reg-username');
    const regEmail = document.getElementById('reg-email');
    const regPassword = document.getElementById('reg-password');
    const confirmPassword = document.getElementById('confirm-password');
    const registerBtn = document.getElementById('register-btn');

    // 工具函数：显示消息
    const showMessage = (message, type = 'info') => {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message message-${type}`;
      messageDiv.textContent = message;
      document.body.appendChild(messageDiv);

      setTimeout(() => messageDiv.style.opacity = '1', 100);

      setTimeout(() => {
        messageDiv.style.opacity = '0';
        setTimeout(() => document.body.removeChild(messageDiv), 300);
      }, 3000);
    };

    // 设置按钮加载状态
    const setButtonLoading = (button, isLoading, originalText) => {
      if (isLoading) {
        button.disabled = true;
        button.textContent = '加载中...';
      } else {
        button.disabled = false;
        button.textContent = originalText;
      }
    };

    // 邮箱验证
    const isValidEmail = email => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

    // API调用：登录
    const loginUser = async (email, password) => {
      try {
        const url = `${API_BASE_URL}/login?email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
        const res = await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });
        return await res.json();
      } catch (e) {
        console.error(e);
        return { code: 500, message: '网络错误' };
      }
    };

    // API调用：注册
    const registerUser = async (email, password, username) => {
      try {
        const userData = {
          email,
          password,
          username,
          nickname: username,
          avatar: '',
          school: '',
          major: ''
        };
        const res = await fetch(`${API_BASE_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(userData)
        });
        return await res.json();
      } catch (e) {
        console.error(e);
        return { code: 500, message: '网络错误' };
      }
    };

    // 登录处理
    const handleLogin = async () => {
      const email = loginEmail.value.trim();
      const password = loginPassword.value.trim();

      if (!email || !password) {
        showMessage('请填写邮箱和密码', 'error');
        return;
      }

      if (!isValidEmail(email)) {
        showMessage('请输入有效邮箱', 'error');
        return;
      }

      setButtonLoading(loginBtn, true, '登录');

      try {
        const result = await loginUser(email, password);
        if (result.code === 200 && result.data) {
          // 保存 token 和用户信息
          localStorage.setItem('accessToken', result.data.accessToken);
          localStorage.setItem('refreshToken', result.data.refreshToken);
          localStorage.setItem('expiresIn', result.data.expiresIn);
          localStorage.setItem('user', JSON.stringify(result.data.user));
          localStorage.setItem('isLoggedIn', 'true');

          showMessage('登录成功！', 'success');

          setTimeout(() => {
            window.location.href = 'noteSquare.html';
          }, 500);
        } else {
          showMessage(result.message || '登录失败', 'error');
        }
      } finally {
        setButtonLoading(loginBtn, false, '登录');
      }
    };

    // 注册处理
    const handleRegister = async () => {
      const email = regEmail.value.trim();
      const password = regPassword.value.trim();
      const username = regUsername.value.trim();
      const confirmPass = confirmPassword.value.trim();

      if (!email || !password || !confirmPass) {
        showMessage('请完整填写注册信息', 'error');
        return;
      }

      if (!isValidEmail(email)) {
        showMessage('请输入有效邮箱', 'error');
        return;
      }

      if (password.length < 6) {
        showMessage('密码至少6位', 'error');
        return;
      }

      if (password !== confirmPass) {
        showMessage('两次密码不一致', 'error');
        return;
      }

      setButtonLoading(registerBtn, true, '注册');

      try {
        const result = await registerUser(email, password, username || email.split('@')[0]);
        if (result.code === 200) {
          showMessage('注册成功，请登录', 'success');

          // 清空注册表单
          regEmail.value = '';
          regPassword.value = '';
          regUsername.value = '';
          confirmPassword.value = '';

          setTimeout(() => {
            // 切换到登录表单
            cont.classList.remove('s--signup');
            // 预填邮箱
            loginEmail.value = email;
            loginPassword.focus();
          }, 1000);
        } else {
          showMessage(result.message || '注册失败', 'error');
        }
      } finally {
        setButtonLoading(registerBtn, false, '注册');
      }
    };

    // 表单切换动画
    imgBtn.addEventListener('click', function () {
      cont.classList.toggle('s--signup');
    });

    // 按钮点击事件
    loginBtn.addEventListener('click', handleLogin);
    registerBtn.addEventListener('click', handleRegister);

    // 回车提交
    loginEmail.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });
    loginPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleLogin();
    });

    regEmail.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleRegister();
    });
    regPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleRegister();
    });
    confirmPassword.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleRegister();
    });

    // 页面加载时检查登录状态
    document.addEventListener('DOMContentLoaded', () => {
      const accessToken = localStorage.getItem('accessToken');
      const user = localStorage.getItem('user');
      if (accessToken && user) {
        console.log('已登录用户:', JSON.parse(user));
        window.location.href = 'noteSquare.html';
      }
    });
  </script>

</body>

</html>