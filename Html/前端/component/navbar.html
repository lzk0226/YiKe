<!-- 修改后的导航栏组件 - component/navbar.html -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>导航栏组件</title>
  <style>
    /* 导航栏相关样式 */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 1000;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .navbar {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2rem;
    }

    .logo {
      display: flex;
      align-items: center;
      font-size: 1.8rem;
      font-weight: bold;
      color: #667eea;
      text-decoration: none;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .logo:hover {
      transform: scale(1.05);
    }

    @keyframes bounce {

      0%,
      20%,
      50%,
      80%,
      100% {
        transform: translateY(0);
      }

      40% {
        transform: translateY(-10px);
      }

      60% {
        transform: translateY(-5px);
      }
    }

    .nav-menu {
      display: flex;
      list-style: none;
      gap: 0.5rem;
      margin: 0;
      padding: 0;
      position: relative;
    }

    .nav-menu a {
      text-decoration: none;
      color: #333;
      font-weight: 500;
      padding: 0.75rem 1.5rem;
      border-radius: 25px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      z-index: 2;
    }

    .nav-menu a:hover {
      color: #667eea;
      transform: translateY(-2px);
    }

    .nav-menu a.active {
      color: #667eea;
      font-weight: 600;
    }

    /* 滑动指示器 */
    .nav-indicator {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 3px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      border-radius: 2px 2px 0 0;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      opacity: 0;
      transform: translateY(100%);
    }

    .nav-indicator.active {
      opacity: 1;
      transform: translateY(0);
    }

    /* 背景滑动效果 */
    .nav-background {
      position: absolute;
      top: 50%;
      left: 0;
      height: 45px;
      background: rgba(102, 126, 234, 0.1);
      border-radius: 25px;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      transform: translateY(-50%);
      opacity: 0;
      z-index: 1;
    }

    .nav-background.active {
      opacity: 1;
    }

    .user-menu {
      display: flex;
      align-items: center;
      position: relative;
    }

    .auth-buttons {
      display: flex;
      gap: 1rem;
    }

    .btn {
      padding: 0.5rem 1.5rem;
      border: none;
      border-radius: 25px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: inline-block;
      position: relative;
      overflow: hidden;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: transparent;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
    }

    /* 移动端汉堡菜单 */
    .mobile-menu-toggle {
      display: none;
      flex-direction: column;
      cursor: pointer;
      padding: 0.5rem;
      background: none;
      border: none;
    }

    .hamburger-line {
      width: 25px;
      height: 3px;
      background: #333;
      margin: 3px 0;
      transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border-radius: 2px;
    }

    .mobile-menu-toggle.active .hamburger-line:nth-child(1) {
      transform: rotate(-45deg) translate(-5px, 6px);
    }

    .mobile-menu-toggle.active .hamburger-line:nth-child(2) {
      opacity: 0;
    }

    .mobile-menu-toggle.active .hamburger-line:nth-child(3) {
      transform: rotate(45deg) translate(-5px, -6px);
    }

    /* 用户头像样式 */
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      border: 2px solid #667eea;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      object-fit: cover;
    }

    .user-avatar:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    /* 用户名显示 */
    .user-info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
      cursor: pointer;
      position: relative;
    }

    .user-name {
      font-size: 0.9rem;
      color: #333;
      font-weight: 500;
    }

    /* 用户下拉菜单样式 */
    .user-dropdown {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
      border: 1px solid rgba(102, 126, 234, 0.1);
      min-width: 180px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 1001;
    }

    .user-dropdown.show {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .user-dropdown::before {
      content: '';
      position: absolute;
      top: -8px;
      right: 20px;
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 8px solid rgba(255, 255, 255, 0.98);
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      color: #333;
      text-decoration: none;
      transition: all 0.2s ease;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 0.9rem;
      gap: 10px;
    }

    .dropdown-item:first-child {
      border-radius: 12px 12px 0 0;
    }

    .dropdown-item:last-child {
      border-radius: 0 0 12px 12px;
    }

    .dropdown-item:hover {
      background: rgba(102, 126, 234, 0.1);
      color: #667eea;
      transform: translateX(5px);
    }

    .dropdown-item:not(:last-child) {
      border-bottom: 1px solid rgba(102, 126, 234, 0.1);
    }

    .dropdown-icon {
      width: 16px;
      height: 16px;
      flex-shrink: 0;
    }

    .dropdown-item.logout {
      color: #e74c3c;
    }

    .dropdown-item.logout:hover {
      background: rgba(231, 76, 60, 0.1);
      color: #c0392b;
    }

    /* 移动端响应式 */
    @media (max-width: 768px) {
      .navbar {
        padding: 1rem;
      }

      .nav-menu {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        flex-direction: column;
        gap: 0;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        border-radius: 0 0 20px 20px;
        padding: 1rem 0;
      }

      .nav-menu.show {
        display: flex;
        animation: slideDown 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }

      .nav-menu a {
        padding: 1rem 2rem;
        border-radius: 0;
        border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        margin: 0;
      }

      .nav-menu a:last-child {
        border-bottom: none;
      }

      .mobile-menu-toggle {
        display: flex;
      }

      .auth-buttons {
        flex-direction: column;
        gap: 0.5rem;
      }

      /* 移动端隐藏滑动指示器 */
      .nav-indicator,
      .nav-background {
        display: none;
      }

      .user-name {
        display: none;
      }

      .user-dropdown {
        right: -10px;
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* 调试样式 - 临时添加 */
    .debug-info {
      position: fixed;
      top: 100px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      padding: 10px;
      border-radius: 5px;
      font-size: 12px;
      z-index: 999999;
      display: none;
      /* 默认隐藏 */
    }

    .logo-img {
      width: 30px;
      height: 30px;
      margin-right: 0.5rem;
      animation: bounce 2s infinite;
    }
  </style>
</head>

<body>
  <!-- 调试信息 - 可以删除 -->
  <div class="debug-info" id="debug-info"></div>

  <!-- 导航栏组件 -->
  <header class="header" id="navbar-component">
    <nav class="navbar">
      <a href="index.html" class="logo">
        <img src="assets/img/1.png" alt="Logo" class="logo-img">
        忆课
      </a>

      <ul class="nav-menu" id="nav-menu">
        <!-- 滑动背景和指示器 -->
        <div class="nav-background" id="nav-background"></div>
        <div class="nav-indicator" id="nav-indicator"></div>

        <li><a href="index.html" data-section="home">首页</a></li>
        <li><a href="noteSquare.html" data-section="notes">笔记广场</a></li>
        <li><a href="ranking.html" data-section="rank">排行榜</a></li>
      </ul>

      <button class="mobile-menu-toggle" id="mobile-menu-toggle">
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
        <span class="hamburger-line"></span>
      </button>

      <!-- 未登录状态 -->
      <div class="auth-buttons" id="auth-buttons">
        <a href="login.html" class="btn btn-secondary" data-action="login">登录/注册</a>
      </div>

      <!-- 已登录状态 -->
      <div class="user-menu" id="user-menu" style="display: none;">
        <div class="user-info" id="user-info">
          <span class="user-name" id="user-name">用户</span>
          <img src="https://via.placeholder.com/40x40/667eea/ffffff?text=U" alt="用户头像" class="user-avatar"
            id="user-avatar">

          <!-- 用户下拉菜单 -->
          <div class="user-dropdown" id="user-dropdown">
            <a href="Profile-container.html" class="dropdown-item">
              <svg class="dropdown-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd">
                </path>
              </svg>
              个人主页
            </a>
            <button class="dropdown-item logout" onclick="handleLogout()">
              <svg class="dropdown-icon" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd"
                  d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"
                  clip-rule="evenodd"></path>
              </svg>
              退出登录
            </button>
          </div>
        </div>
      </div>
    </nav>
  </header>

  <script>
    class NavbarComponent {
      constructor(options = {}) {
        this.options = {
          isLoggedIn: false,
          userName: '',
          userAvatar: '',
          currentPage: 'home',
          ...options
        };
        this.navLinks = [];
        this.navBackground = null;
        this.navIndicator = null;
        this.isAnimating = false;
        this.dropdownTimeout = null;
        this.init();
      }

      init() {
        this.cacheElements();
        this.setupEventListeners();
        this.setupScrollEffect();
        this.setupUserDropdown();
        this.checkLoginStatus();
        this.initActiveNav();
        this.debugLog('Navbar initialized');
      }

      debugLog(message, data = null) {
        const debugElement = document.getElementById('debug-info');
        if (debugElement && window.location.search.includes('debug=true')) {
          debugElement.style.display = 'block';
          debugElement.innerHTML = `${message}<br>${data ? JSON.stringify(data, null, 2) : ''}`;
          console.log('Navbar Debug:', message, data);
        }
      }

      cacheElements() {
        this.navLinks = Array.from(document.querySelectorAll('.nav-menu a'));
        this.navBackground = document.getElementById('nav-background');
        this.navIndicator = document.getElementById('nav-indicator');
        this.authButtons = document.getElementById('auth-buttons');
        this.userMenu = document.getElementById('user-menu');
        this.userAvatar = document.getElementById('user-avatar');
        this.userName = document.getElementById('user-name');
        this.userInfo = document.getElementById('user-info');
        this.userDropdown = document.getElementById('user-dropdown');
      }

      setupUserDropdown() {
        if (!this.userInfo || !this.userDropdown) return;

        // 鼠标进入用户信息区域
        this.userInfo.addEventListener('mouseenter', () => {
          this.clearDropdownTimeout();
          this.showUserDropdown();
        });

        // 鼠标离开用户信息区域
        this.userInfo.addEventListener('mouseleave', () => {
          this.setDropdownTimeout(() => {
            this.hideUserDropdown();
          }, 200);
        });

        // 鼠标进入下拉菜单
        this.userDropdown.addEventListener('mouseenter', () => {
          this.clearDropdownTimeout();
        });

        // 鼠标离开下拉菜单
        this.userDropdown.addEventListener('mouseleave', () => {
          this.hideUserDropdown();
        });

        // 点击外部关闭下拉菜单
        document.addEventListener('click', (e) => {
          if (!this.userInfo.contains(e.target) && !this.userDropdown.contains(e.target)) {
            this.hideUserDropdown();
          }
        });
      }

      showUserDropdown() {
        if (this.userDropdown) {
          this.userDropdown.classList.add('show');
        }
      }

      hideUserDropdown() {
        if (this.userDropdown) {
          this.userDropdown.classList.remove('show');
        }
      }

      setDropdownTimeout(callback, delay) {
        this.clearDropdownTimeout();
        this.dropdownTimeout = setTimeout(callback, delay);
      }

      clearDropdownTimeout() {
        if (this.dropdownTimeout) {
          clearTimeout(this.dropdownTimeout);
          this.dropdownTimeout = null;
        }
      }

      checkLoginStatus() {
        try {
          const accessToken = localStorage.getItem('accessToken');
          const userStr = localStorage.getItem('user');
          const isLoggedIn = localStorage.getItem('isLoggedIn');

          this.debugLog('Login Check', {
            hasToken: !!accessToken,
            hasUser: !!userStr,
            isLoggedIn: isLoggedIn,
            tokenLength: accessToken ? accessToken.length : 0
          });

          if (accessToken && userStr && isLoggedIn === 'true') {
            try {
              const userData = JSON.parse(userStr);
              this.debugLog('Parsed User Data', userData);

              if (userData && (userData.username || userData.nickname)) {
                this.login({
                  username: userData.username || userData.nickname,
                  avatar: userData.avatar || '/assets/img/2.jpg'
                });
                this.debugLog('Login applied successfully');
                return;
              }
            } catch (parseError) {
              this.debugLog('Parse Error', parseError.message);
              this.clearInvalidTokens();
            }
          }

          this.logout();
          this.debugLog('No valid login found, showing auth buttons');
        } catch (error) {
          this.debugLog('Check Login Error', error.message);
          this.logout();
        }
      }

      clearInvalidTokens() {
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('user');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('expiresIn');
      }

      initActiveNav() {
        const currentPath = window.location.pathname;
        const currentPage = this.detectCurrentPage(currentPath);
        this.options.currentPage = currentPage;
        const activeLink = document.querySelector(`[data-section="${currentPage}"]`);
        if (activeLink) this.setActiveNavItem(activeLink, false);
      }

      detectCurrentPage(pathname) {
        const fileName = pathname.split('/').pop();
        if (fileName === 'noteSquare.html') return 'notes';
        if (fileName === 'ranking.html') return 'rank';
        if (fileName === 'index.html' || fileName === '' || pathname === '/') return 'home';
        return this.options.currentPage;
      }

      setupEventListeners() {
        const mobileToggle = document.getElementById('mobile-menu-toggle');
        const navMenu = document.getElementById('nav-menu');

        if (mobileToggle) {
          mobileToggle.addEventListener('click', () => {
            mobileToggle.classList.toggle('active');
            navMenu.classList.toggle('show');
          });
        }

        this.navLinks.forEach(link => {
          link.addEventListener('click', e => {
            const href = link.getAttribute('href');
            if (href.includes('.html')) return;
            e.preventDefault();
            const section = link.getAttribute('data-section');
            if (section === this.options.currentPage) return;
            this.setActiveNavItem(link, true);
            this.options.currentPage = section;
          });

          if (window.innerWidth > 768) {
            link.addEventListener('mouseenter', () => {
              if (!link.classList.contains('active') && !this.isAnimating) {
                this.updateNavIndicator(link, false);
              }
            });
          }
        });

        if (window.innerWidth > 768) {
          document.getElementById('nav-menu').addEventListener('mouseleave', () => {
            const activeLink = document.querySelector('.nav-menu a.active');
            if (activeLink && !this.isAnimating) this.updateNavIndicator(activeLink, false);
          });
        }

        window.addEventListener('resize', () => {
          if (window.innerWidth > 768) {
            const activeLink = document.querySelector('.nav-menu a.active');
            if (activeLink) setTimeout(() => this.updateNavIndicator(activeLink, false), 100);
          }
        });
      }

      setupScrollEffect() {
        const header = document.querySelector('.header');
        let ticking = false;
        window.addEventListener('scroll', () => {
          if (!ticking) {
            requestAnimationFrame(() => {
              const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
              header.style.background = scrollTop > 100 ? 'rgba(255,255,255,0.98)' : 'rgba(255,255,255,0.95)';
              header.style.boxShadow = scrollTop > 100 ? '0 2px 20px rgba(0,0,0,0.15)' : '0 2px 20px rgba(0,0,0,0.1)';
              ticking = false;
            });
            ticking = true;
          }
        });
      }

      updateNavIndicator(activeLink, animate = true) {
        if (window.innerWidth <= 768) return;
        const linkRect = activeLink.getBoundingClientRect();
        const navRect = document.getElementById('nav-menu').getBoundingClientRect();
        const left = linkRect.left - navRect.left;
        const width = linkRect.width;
        if (this.navBackground) {
          this.navBackground.style.left = `${left}px`;
          this.navBackground.style.width = `${width}px`;
          if (animate) this.navBackground.classList.add('active');
        }
        if (this.navIndicator) {
          this.navIndicator.style.left = `${left}px`;
          this.navIndicator.style.width = `${width}px`;
          if (animate) this.navIndicator.classList.add('active');
        }
      }

      setActiveNavItem(activeLink, animate = true) {
        if (this.isAnimating && animate) return;
        if (animate) {
          this.isAnimating = true;
          setTimeout(() => { this.isAnimating = false; }, 400);
        }
        this.navLinks.forEach(link => link.classList.remove('active'));
        activeLink.classList.add('active');
        this.updateNavIndicator(activeLink, animate);
      }

      updateAuthState() {
        if (!this.authButtons || !this.userMenu) {
          this.debugLog('Auth elements not found');
          return;
        }

        this.debugLog('Updating auth state', {
          isLoggedIn: this.options.isLoggedIn,
          userName: this.options.userName,
          userAvatar: this.options.userAvatar
        });

        if (this.options.isLoggedIn) {
          this.authButtons.style.display = 'none';
          this.userMenu.style.display = 'flex';

          if (this.userAvatar) {
            this.userAvatar.src = this.options.userAvatar || '/assets/img/2.jpg';
          }
          if (this.userName) {
            this.userName.textContent = this.options.userName || '用户';
          }

          this.debugLog('Auth state updated to logged in');
        } else {
          this.authButtons.style.display = 'flex';
          this.userMenu.style.display = 'none';
          this.debugLog('Auth state updated to logged out');
        }
      }

      login(userData) {
        this.options.isLoggedIn = true;
        this.options.userName = userData.username || userData.nickname || '用户';
        this.options.userAvatar = userData.avatar || '/assets/img/2.jpg';
        this.updateAuthState();
        this.debugLog('User logged in', userData);
      }

      logout() {
        this.options.isLoggedIn = false;
        this.options.userName = '';
        this.options.userAvatar = '';
        this.hideUserDropdown(); // 隐藏下拉菜单
        this.updateAuthState();
        this.debugLog('User logged out');
      }

      // 强制刷新登录状态的公共方法
      refreshLoginStatus() {
        this.checkLoginStatus();
      }
    }

    // 退出登录处理函数
    function handleLogout() {
      // 确认对话框
      if (confirm('确定要退出登录吗？')) {
        // 清除本地存储的登录信息
        localStorage.removeItem('accessToken');
        localStorage.removeItem('refreshToken');
        localStorage.removeItem('user');
        localStorage.removeItem('isLoggedIn');
        localStorage.removeItem('expiresIn');

        // 更新导航栏状态
        if (window.navbarInstance) {
          window.navbarInstance.logout();
        }

        // 跳转到首页或登录页
        window.location.href = 'index.html';
      }
    }

    // 跳转到个人资料页面 (保留原有功能)
    function goToProfile() {
      window.location.href = 'Profile-container.html';
    }

    // 全局实例
    window.navbarInstance = new NavbarComponent();

    // 页面加载完成后的处理
    document.addEventListener('DOMContentLoaded', () => {
      if (!window.navbarInstance) {
        window.navbarInstance = new NavbarComponent();
      }

      setTimeout(() => {
        window.navbarInstance.refreshLoginStatus();
      }, 100);
    });

    // 监听存储变化（当其他页面登录时）
    window.addEventListener('storage', (e) => {
      if (e.key === 'accessToken' || e.key === 'isLoggedIn' || e.key === 'user') {
        if (window.navbarInstance) {
          window.navbarInstance.refreshLoginStatus();
        }
      }
    });

    // 监听页面焦点重新获得（从其他标签页回来时）
    window.addEventListener('focus', () => {
      if (window.navbarInstance) {
        setTimeout(() => {
          window.navbarInstance.refreshLoginStatus();
        }, 100);
      }
    });
  </script>
</body>

</html>